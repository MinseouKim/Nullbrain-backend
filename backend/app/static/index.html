<!DOCTYPE html>
<html>
  <head>
    <title>AI 홈 트레이너 (Frontend Processing)</title>
    <link rel="stylesheet" href="/static/index_styles.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <h1>AI 홈 트레이너 (Frontend Processing)</h1>
    <button id="connectButton">운동 시작</button>
    <p>AI 피드백: <span id="feedbackText">AI 코칭 대기 중...</span></p>

    <div style="position: relative">
      <video id="videoElement" style="display: none"></video>
      <canvas id="canvasElement" width="640px" height="480px"></canvas>
    </div>

    <script>
      const connectButton = document.getElementById("connectButton");
      const feedbackText = document.getElementById("feedbackText");
      const videoElement = document.getElementById("videoElement");
      const canvasElement = document.getElementById("canvasElement");
      const canvasCtx = canvasElement.getContext("2d");

      let ws;
      const exercise = "squat"; // 테스트할 운동

      // --- 👇 onResults 함수가 수정되었습니다 --- // [!code focus:60]
      function onResults(results) {
        // 1. 캔버스 준비
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );

        // 2. 전신 인식 필터링 로직
        const visibilityThreshold = 0.7;
        let isFullBodyVisible = false;

        if (results.poseLandmarks) {
          const leftAnkle = results.poseLandmarks[27];
          const rightAnkle = results.poseLandmarks[28];
          if (
            leftAnkle.visibility > visibilityThreshold &&
            rightAnkle.visibility > visibilityThreshold
          ) {
            isFullBodyVisible = true;
          }
        }

        // 3. 필터링 결과에 따라 동작 결정
        if (isFullBodyVisible) {
          // 전신이 보일 때: 관절 그리고 데이터 전송
          drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
            color: "#00FF00",
            lineWidth: 4,
          });
          drawLandmarks(canvasCtx, results.poseLandmarks, {
            color: "#FF0000",
            lineWidth: 2,
          });

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(results.poseLandmarks));
          }
        } else {
          // 전신이 아닐 때: 안내 메시지 표시
          canvasCtx.font = "bold 30px sans-serif";
          canvasCtx.fillStyle = "white";
          canvasCtx.textAlign = "center";
          canvasCtx.fillText(
            "카메라에 전신이 나오도록 뒤로 물러나세요.",
            canvasElement.width / 2,
            canvasElement.height / 2
          );
        }

        canvasCtx.restore();
      }

      // --- (이하 코드는 동일합니다) ---

      const pose = new Pose({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
      });
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.2,
        minTrackingConfidence: 0.2,
      });
      pose.onResults(onResults);

      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await pose.send({ image: videoElement });
        },
        width: 640,
        height: 480,
      });

      connectButton.addEventListener("click", () => {
        if (connectButton.textContent === "운동 시작") {
          ws = new WebSocket(`ws://localhost:8000/ws/${exercise}`);
          ws.onopen = () => {
            console.log("백엔드 연결 성공");
            connectButton.textContent = "운동 종료";
          };
          ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            feedbackText.textContent = data.feedback || "...";
          };
          ws.onclose = () => {
            console.log("백엔드 연결 종료");
            camera.stop();
            connectButton.textContent = "운동 시작";
            feedbackText.textContent = "AI 코칭 대기 중...";
          };
          camera.start();
        } else {
          if (ws) ws.close();
        }
      });
    </script>
  </body>
</html>
