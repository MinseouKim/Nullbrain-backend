<!DOCTYPE html>
<html>
  <head>
    <title>AI 홈 트레이너 (Frontend Processing)</title>
    <link rel="stylesheet" href="/static/index_styles.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <h1>AI 홈 트레이너 (Frontend Processing)</h1>
    <button id="connectButton">운동 시작</button>
    <p>AI 피드백: <span id="feedbackText">AI 코칭 대기 중...</span></p>

    <div style="position: relative">
      <video id="videoElement" style="display: none"></video>
      <canvas id="canvasElement" width="640px" height="480px"></canvas>
    </div>

    <script>
      const connectButton = document.getElementById("connectButton");
      const feedbackText = document.getElementById("feedbackText");
      const videoElement = document.getElementById("videoElement");
      const canvasElement = document.getElementById("canvasElement");
      const canvasCtx = canvasElement.getContext("2d");

      let ws;
      const exercise = "squat"; // 테스트할 운동

      // MediaPipe Pose 결과를 처리하는 콜백 함수
      function onResults(results) {
        // 1. 캔버스에 웹캠 영상과 관절 그리기
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );
        if (results.poseLandmarks) {
          drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
            color: "#00FF00",
            lineWidth: 4,
          });
          drawLandmarks(canvasCtx, results.poseLandmarks, {
            color: "#FF0000",
            lineWidth: 2,
          });
        }
        canvasCtx.restore();

        // 2. 백엔드로 관절 좌표 데이터(JSON) 전송
        if (results.poseLandmarks && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify(results.poseLandmarks));
        }
      }

      // MediaPipe Pose 객체 초기화
      const pose = new Pose({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
      });
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });
      pose.onResults(onResults);

      // 웹캠 및 MediaPipe 실행 로직
      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await pose.send({ image: videoElement });
        },
        width: 640,
        height: 480,
      });

      // 버튼 클릭 이벤트
      connectButton.addEventListener("click", () => {
        if (connectButton.textContent === "운동 시작") {
          // 1. 웹소켓 연결
          ws = new WebSocket(`ws://localhost:8000/ws/${exercise}`);
          ws.onopen = () => {
            console.log("백엔드 연결 성공");
            connectButton.textContent = "운동 종료";
          };
          ws.onmessage = (event) => {
            // 2. 백엔드로부터 받은 피드백을 화면에 표시
            const data = JSON.parse(event.data);
            feedbackText.textContent = data.feedback || "...";
          };
          ws.onclose = () => {
            console.log("백엔드 연결 종료");
            camera.stop();
            connectButton.textContent = "운동 시작";
            feedbackText.textContent = "AI 코칭 대기 중...";
          };

          // 3. 웹캠 시작
          camera.start();
        } else {
          if (ws) ws.close();
        }
      });
    </script>
  </body>
</html>
