<!DOCTYPE html>
<html>
  <head>
    <title>AI í™ˆ íŠ¸ë ˆì´ë„ˆ (Frontend Processing)</title>
    <link rel="stylesheet" href="/static/index_styles.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <h1>AI í™ˆ íŠ¸ë ˆì´ë„ˆ (Frontend Processing)</h1>
    <button id="connectButton">ìš´ë™ ì‹œì‘</button>
    <p>AI í”¼ë“œë°±: <span id="feedbackText">AI ì½”ì¹­ ëŒ€ê¸° ì¤‘...</span></p>

    <div style="position: relative">
      <video id="videoElement" style="display: none"></video>
      <canvas id="canvasElement" width="640px" height="480px"></canvas>
    </div>

    <script>
      const connectButton = document.getElementById("connectButton");
      const feedbackText = document.getElementById("feedbackText");
      const videoElement = document.getElementById("videoElement");
      const canvasElement = document.getElementById("canvasElement");
      const canvasCtx = canvasElement.getContext("2d");

      let ws;
      const exercise = "squat"; // í…ŒìŠ¤íŠ¸í•  ìš´ë™

      // --- ğŸ‘‡ onResults í•¨ìˆ˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ --- // [!code focus:60]
      function onResults(results) {
        // 1. ìº”ë²„ìŠ¤ ì¤€ë¹„
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(
          results.image,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );

        // 2. ì „ì‹  ì¸ì‹ í•„í„°ë§ ë¡œì§
        const visibilityThreshold = 0.7;
        let isFullBodyVisible = false;

        if (results.poseLandmarks) {
          const leftAnkle = results.poseLandmarks[27];
          const rightAnkle = results.poseLandmarks[28];
          if (
            leftAnkle.visibility > visibilityThreshold &&
            rightAnkle.visibility > visibilityThreshold
          ) {
            isFullBodyVisible = true;
          }
        }

        // 3. í•„í„°ë§ ê²°ê³¼ì— ë”°ë¼ ë™ì‘ ê²°ì •
        if (isFullBodyVisible) {
          // ì „ì‹ ì´ ë³´ì¼ ë•Œ: ê´€ì ˆ ê·¸ë¦¬ê³  ë°ì´í„° ì „ì†¡
          drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {
            color: "#00FF00",
            lineWidth: 4,
          });
          drawLandmarks(canvasCtx, results.poseLandmarks, {
            color: "#FF0000",
            lineWidth: 2,
          });

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(results.poseLandmarks));
          }
        } else {
          // ì „ì‹ ì´ ì•„ë‹ ë•Œ: ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
          canvasCtx.font = "bold 30px sans-serif";
          canvasCtx.fillStyle = "white";
          canvasCtx.textAlign = "center";
          canvasCtx.fillText(
            "ì¹´ë©”ë¼ì— ì „ì‹ ì´ ë‚˜ì˜¤ë„ë¡ ë’¤ë¡œ ë¬¼ëŸ¬ë‚˜ì„¸ìš”.",
            canvasElement.width / 2,
            canvasElement.height / 2
          );
        }

        canvasCtx.restore();
      }

      // --- (ì´í•˜ ì½”ë“œëŠ” ë™ì¼í•©ë‹ˆë‹¤) ---

      const pose = new Pose({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
      });
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.2,
        minTrackingConfidence: 0.2,
      });
      pose.onResults(onResults);

      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await pose.send({ image: videoElement });
        },
        width: 640,
        height: 480,
      });

      connectButton.addEventListener("click", () => {
        if (connectButton.textContent === "ìš´ë™ ì‹œì‘") {
          ws = new WebSocket(`ws://localhost:8000/ws/${exercise}`);
          ws.onopen = () => {
            console.log("ë°±ì—”ë“œ ì—°ê²° ì„±ê³µ");
            connectButton.textContent = "ìš´ë™ ì¢…ë£Œ";
          };
          ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            feedbackText.textContent = data.feedback || "...";
          };
          ws.onclose = () => {
            console.log("ë°±ì—”ë“œ ì—°ê²° ì¢…ë£Œ");
            camera.stop();
            connectButton.textContent = "ìš´ë™ ì‹œì‘";
            feedbackText.textContent = "AI ì½”ì¹­ ëŒ€ê¸° ì¤‘...";
          };
          camera.start();
        } else {
          if (ws) ws.close();
        }
      });
    </script>
  </body>
</html>
