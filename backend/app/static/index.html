<!DOCTYPE html>
<html>
  <head>
    <title>AI í™ˆ íŠ¸ë ˆì´ë„ˆ (Test)</title>
    <link rel="stylesheet" href="/static/index_styles.css" />
  </head>
  <body>
    <h1>AI í™ˆ íŠ¸ë ˆì´ë„ˆ (Test)</h1>

    <button id="connectButton">ì›¹ìº  ì¼œê¸°</button>
    <button id="feedbackButton" style="display: none">AI í”¼ë“œë°± ì‹œì‘</button>

    <br /><br />
    <img id="videoStream" width="640" height="480" />

    <script>
      let ws;
      const connectButton = document.getElementById("connectButton");
      const feedbackButton = document.getElementById("feedbackButton"); // [!code ++]
      const videoStream = document.getElementById("videoStream");

      // main.pyê°€ ì´ ë¶€ë¶„ì„ ìš´ë™ ì´ë¦„ìœ¼ë¡œ êµì²´í•´ì¤ë‹ˆë‹¤.
      const exercise = "EXERCISE_PLACEHOLDER";
      let isFeedbackRunning = false; // [!code ++]

      function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;

        const wsURL = `ws://localhost:8000/ws/${exercise}`;
        ws = new WebSocket(wsURL);

        // --- ğŸ‘‡ onmessage í•¸ë“¤ëŸ¬ ìˆ˜ì •: JSON ë°ì´í„° ì²˜ë¦¬ ---
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.image) {
            // Base64 ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ img íƒœê·¸ì˜ srcì— ì§ì ‘ ì„¤ì •
            videoStream.src = `data:image/jpeg;base64,${data.image}`;
          }
        };

        ws.onopen = () => {
          console.log("WebSocket ì—°ê²° ì„±ê³µ");
          connectButton.textContent = "ì›¹ìº  ë„ê¸°";
          feedbackButton.style.display = "inline-block"; // [!code ++] # ì—°ê²° ì„±ê³µ ì‹œ í”¼ë“œë°± ë²„íŠ¼ ë³´ì´ê¸°
          feedbackButton.textContent = "AI í”¼ë“œë°± ì‹œì‘"; // [!code ++]
        };
        ws.onclose = () => {
          console.log("WebSocket ì—°ê²° ì¢…ë£Œ");
          connectButton.textContent = "ì›¹ìº  ì¼œê¸°";
          feedbackButton.style.display = "none"; // [!code ++] # ì—°ê²° ì¢…ë£Œ ì‹œ í”¼ë“œë°± ë²„íŠ¼ ìˆ¨ê¸°ê¸°
          isFeedbackRunning = false; // [!code ++]
          videoStream.src = "";
        };
      }

      function disconnectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
      }

      // --- í”¼ë“œë°± ì‹œì‘/ì¤‘ì§€ í•¨ìˆ˜ ì¶”ê°€ ---
      function toggleFeedback() {
        // [!code ++]
        if (!ws || ws.readyState !== WebSocket.OPEN) return; // [!code ++]

        isFeedbackRunning = !isFeedbackRunning; // [!code ++]
        const action = isFeedbackRunning ? "start_feedback" : "stop_feedback"; // [!code ++]

        // ë°±ì—”ë“œë¡œ JSON ë©”ì‹œì§€ ì „ì†¡
        ws.send(JSON.stringify({ action: action })); // [!code ++]

        feedbackButton.textContent = isFeedbackRunning
          ? "AI í”¼ë“œë°± ì¤‘ì§€"
          : "AI í”¼ë“œë°± ì‹œì‘"; // [!code ++]
        console.log(`Sent action: ${action}`); // [!code ++]
      } // [!code ++]

      connectButton.addEventListener("click", () => {
        if (connectButton.textContent === "ì›¹ìº  ì¼œê¸°") {
          connectWebSocket();
        } else {
          disconnectWebSocket();
        }
      });

      feedbackButton.addEventListener("click", toggleFeedback); // [!code ++]
    </script>
  </body>
</html>
