<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>웹캠 + Pose Overlay</title>
  <style>
    body { font:14px system-ui; background:#0b0b0c; color:#eaeaea; }
    .stage { position:relative; display:inline-block; }
    img, canvas { width:640px; height:480px; display:block; }
    canvas { position:absolute; left:0; top:0; pointer-events:none; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #444; background:#1c1f24; color:#eee; cursor:pointer; }
  </style>
</head>
<body>
  <h1>웹캠 + 포즈 오버레이</h1>
  <button id="btn">웹캠 켜기</button>
  <span id="state">idle</span>
  <span id="autoHint" style="margin-left:8px;color:#9ac6ff"></span>
  <div class="stage" style="margin-top:10px">
    <img id="video" width="640" height="480" />
    <canvas id="overlay" width="640" height="480"></canvas>
  </div>
  <div style="margin:8px 0">
  <button id="prev">이전</button>
  <button id="next">다음</button>
  <button id="save" disabled>프로필 저장</button>
  <span id="step">STEP 1/4: 정자세(키 보정)</span>
</div>
<div style="margin:8px 0">
  키(cm) <input id="height" type="number" value="175" style="width:70px">
  몸무게(kg) <input id="weight" type="number" value="70" style="width:70px">
  나이 <input id="age" type="number" value="22" style="width:60px">
  주의부위 
  <select id="pain"><option value="none">없음</option><option value="knee">무릎</option><option value="back">허리</option><option value="shoulder">어깨</option></select>
  목표 
  <select id="goal"><option value="fatloss">체지방 감량</option><option value="strength">근력</option><option value="mobility">가동성</option></select>
</div>

<script>
(() => {
  const btn = document.getElementById('btn');
  const stateEl = document.getElementById('state');
  const img = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  let wsImg = null;   // ws://.../ws (JPEG)
  let wsPose = null;  // ws://.../ws/pose (JSON)
  let lastURL = null;

  const pairs = [
    ['left_shoulder','left_elbow'],['left_elbow','left_wrist'],
    ['right_shoulder','right_elbow'],['right_elbow','right_wrist'],
    ['left_shoulder','left_hip'],['right_shoulder','right_hip'],
    ['left_hip','left_knee'],['left_knee','left_ankle'],
    ['right_hip','right_knee'],['right_knee','right_ankle']
  ];

  function drawSkeleton(keypoints, size) {
    // 캔버스 크기 조정(서버 프레임 크기와 동일)
    if (size && (canvas.width !== size.w || canvas.height !== size.h)) {
      canvas.width = size.w; canvas.height = size.h;
      // <img> CSS 픽셀은 따로 유지(640×480). 비율이 바뀌면 스타일도 맞춰주세요.
    }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (!keypoints) return;

    // 점수 0.3 이상만 사용
    const dict = {};
    keypoints.forEach(k => { if ((k.score ?? 0) > 0.3) dict[k.name || k.part] = k; });

    ctx.lineWidth = 3; ctx.strokeStyle = '#39b3ff'; ctx.fillStyle = '#ffd66e';
    // 선
    pairs.forEach(([a,b]) => {
      const A = dict[a], B = dict[b];
      if (A && B) {
        ctx.beginPath(); ctx.moveTo(A.x, A.y); ctx.lineTo(B.x, B.y); ctx.stroke();
      }
    });
    // 점
    Object.values(dict).forEach(k => {
      if (k.score > 0.45) { ctx.beginPath(); ctx.arc(k.x, k.y, 4, 0, Math.PI*2); ctx.fill(); }
    });
  }

  function start() {
    // 1) 영상
    wsImg = new WebSocket("ws://127.0.0.1:8000/ws");
    wsImg.binaryType = 'blob';
    wsImg.onopen   = () => { stateEl.textContent = 'video: connected'; };
    wsImg.onmessage = (ev) => {
      if (lastURL) URL.revokeObjectURL(lastURL);
      const url = URL.createObjectURL(ev.data);
      img.src = url;
      lastURL = url;
    };  
    wsImg.onclose  = () => { stateEl.textContent = 'video: closed'; };

    // 2) 키포인트
    const h = Number(document.getElementById('height').value) || '';
  wsPose = new WebSocket(`ws://127.0.0.1:8000/ws/pose?height_cm=${h}`);
    wsPose.onopen   = () => { console.log('pose connected'); };
    wsPose.onmessage = (ev) => {
      try {
        const j = JSON.parse(ev.data);
        lastPose = j;
        drawSkeleton(j.keypoints, j.size);
        updateAutoStep(j);
      } catch (e) {
        console.warn('bad pose msg', e);
      }
    };
    wsPose.onclose  = () => { console.log('pose closed'); };

    btn.textContent = '끄기';
  }

  function stop() {
    if (wsImg && wsImg.readyState === WebSocket.OPEN) wsImg.close();
    if (wsPose && wsPose.readyState === WebSocket.OPEN) wsPose.close();
    wsImg = wsPose = null;
    if (lastURL) { URL.revokeObjectURL(lastURL); lastURL=null; }
    img.src = '';
    ctx.clearRect(0,0,canvas.width,canvas.height);
    btn.textContent = '웹캠 켜기';
    stateEl.textContent = 'idle';
  }

  btn.addEventListener('click', () => {
    if (btn.textContent === '웹캠 켜기') start(); else stop();
  });
  
})();


const stepEl = document.getElementById('step');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const saveBtn = document.getElementById('save');
  const heightEl = document.getElementById('height');
  const weightEl = document.getElementById('weight');
  const ageEl = document.getElementById('age');
  const painEl = document.getElementById('pain');
  const goalEl = document.getElementById('goal');

  let step = 1;
  function updateStepLabel(){
    const labels = ['준비','정자세(키 보정)','스쿼트 2~3회','힙힌지 2~3회','오버헤드 2~3회','요약'];
    stepEl.textContent = `STEP ${Math.min(step,4)}/4: ${labels[step]||'요약'}`;
  }
  updateStepLabel();

  prevBtn.onclick = () => { if (step>1) { step--; updateStepLabel(); } };
  nextBtn.onclick = () => { if (step<4) { step++; updateStepLabel(); } else { step=5; updateStepLabel(); saveBtn.disabled=false; } };

  // /ws/pose에서 오는 최신 메트릭/프로필 취합
  let lastPose = null;
  let latestProfile = null;

   saveBtn.onclick = async () => {
    if (!lastPose || !lastPose.metrics) { alert('측정 데이터가 부족합니다.'); return; }
    const profile = {
      version: 'v2',
      body: {
        height_cm: Number(heightEl.value)||null,
        weight_kg: Number(weightEl.value)||null,
        age: Number(ageEl.value)||null,
        pain: painEl.value,
        goal: goalEl.value
      },
      measures: {
        // 서버 메트릭 그대로
        knee_min_angle_deg: lastPose.metrics.knee_min_angle_deg ?? null,
        trunk_max_flexion_deg: lastPose.metrics.trunk_max_flexion_deg ?? null,
        valgus_index_max: lastPose.metrics.valgus_index_max ?? 0,
        overhead_ok: !!lastPose.metrics.overhead_ok,
        lengths_cm: lastPose.metrics.lengths_cm ?? null
      },
      thresholds: lastPose.metrics.thresholds || null,
      cm_per_px: lastPose.cm_per_px ?? null,
      notes: 'Calibration profile saved from WS / BlazePose'
    };
    // 저장
    const res = await fetch('/api/profile', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(profile)
    });
    const r = await res.json();
    if (r.ok) { alert('저장 완료! id: ' + r.id); }
    else { alert('저장 실패'); }
  };

  // ===== 자동 진행 파라미터 =====
const autoEl = document.getElementById('autoHint');
let stableCount = 0;      // 현재 스텝의 '조건 충족'이 연속된 프레임 수
const NEED_STABLE = 15;   // 몇 프레임 연속으로 충족해야 완료로 볼지(약 0.5초)

// 각 스텝 완료 플래그
const done = { step1:false, step2:false, step3:false, step4:false };

// 자동 진행 메인
function updateAutoStep(j) {
  if (!j || !j.metrics) return;

  // 현재 스텝 상태 라벨
  const label = (txt) => { if (autoEl) autoEl.textContent = txt; };

  // ===== STEP 1: 정자세(전신/키 보정) =====
  if (step === 1 && !done.step1) {
    const f = j.cm_per_px;
    if (f) {
      // cm/px가 잡혔으면 '전신 감지'로 판단
      stableCount++;
      label(`정자세 측정중… (${stableCount}/${NEED_STABLE})`);
      if (stableCount >= NEED_STABLE) {
        done.step1 = true;
        label('정자세 측정 완료');
        stableCount = 0;
        step = 2; updateStepLabel();
      }
    } else {
      // 아직 전신이 안 잡힌 상태
      stableCount = 0;
      label('카메라에서 전신이 모두 보이도록 한 걸음/두 걸음 뒤로 가세요');
    }
    return;
  }

  // ===== STEP 2: 스쿼트 2~3회(깊이 도달) =====
  if (step === 2 && !done.step2) {
    const kneeMin = j.metrics.knee_min_angle_deg; // 관측 최소각(낮을수록 깊음)
    const target = 95;                            // 원하는 깊이(원하면 입력값으로 연결)
    if (typeof kneeMin === 'number' && kneeMin <= target) {
      stableCount++;
      label(`스쿼트 깊이 확인중… (${stableCount}/${NEED_STABLE})`);
      if (stableCount >= NEED_STABLE) {
        done.step2 = true;
        label('스쿼트 측정 완료');
        stableCount = 0;
        step = 3; updateStepLabel();
      }
    } else {
      stableCount = 0;
      label('스쿼트를 2~3회 내려갔다 올라오세요');
    }
    return;
  }

  // ===== STEP 3: 힙힌지 2~3회(전굴 각도) =====
  if (step === 3 && !done.step3) {
    const trunk = j.metrics.trunk_max_flexion_deg; // 최대 상체 전굴 각
    if (typeof trunk === 'number' && trunk >= 25) {
      stableCount++;
      label(`힙힌지 확인중… (${stableCount}/${NEED_STABLE})`);
      if (stableCount >= NEED_STABLE) {
        done.step3 = true;
        label('힙힌지 측정 완료');
        stableCount = 0;
        step = 4; updateStepLabel();
      }
    } else {
      stableCount = 0;
      label('엉덩이를 뒤로 빼며 상체를 굽혔다 펴는 동작을 2~3회 해보세요');
    }
    return;
  }

  // ===== STEP 4: 오버헤드(손목이 어깨보다 위) =====
  if (step === 4 && !done.step4) {
    if (j.metrics.overhead_ok) {
      stableCount++;
      label(`오버헤드 확인중… (${stableCount}/${NEED_STABLE})`);
      if (stableCount >= NEED_STABLE) {
        done.step4 = true;
        label('오버헤드 측정 완료');
        stableCount = 0;
        step = 5; updateStepLabel();
        // 저장 버튼 활성화
        const saveBtn = document.getElementById('save');
        if (saveBtn) saveBtn.disabled = false;
      }
    } else {
      stableCount = 0;
      label('양팔을 귀 옆으로 곧게 들어 올려보세요');
    }
    return;
  }

  // 요약 단계
  if (step >= 5) {
    label('요약/저장 단계입니다');
  }
}

</script>
</body>
</html>
