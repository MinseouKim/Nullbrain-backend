<!doctype html>
<meta charset="utf-8">
<title>웹캠 + Pose (YOLOv8)</title>
<style>
  body{font:14px system-ui;background:#0b0b0c;color:#eaeaea}
  .stage{position:relative;display:inline-block}
  img,canvas{width:640px;height:480px;display:block}
  canvas{position:absolute;left:0;top:0;pointer-events:none}
  button,select,input{padding:8px 12px;border-radius:8px;border:1px solid #444;background:#1c1f24;color:#eee}
  .hud{margin-top:8px}
  .chip{display:inline-block;margin-right:6px;background:#17212b;padding:3px 8px;border-radius:999px;color:#cfe8ff}
  .ok{color:#3fd37c}.warn{color:#ffd66e}
</style>
<body>
<h2>웹캠 + 스켈레톤 (YOLOv8-Pose)</h2>
<button id="btn">웹캠 켜기</button>
<span id="state">idle</span>
<div class="stage" style="margin-top:10px">
  <img id="video" width="640" height="480"/>
  <canvas id="overlay" width="640" height="480"></canvas>
</div>

<div class="hud">
  <span class="chip">STEP <span id="step">1</span>/4</span>
  <span class="chip" id="phase">정자세(키 보정)</span>
  <span class="chip">advice: <span id="advice">—</span></span>
  <span class="chip">cm/px: <span id="cmppx">—</span></span>
</div>

<div style="margin:8px 0">
  키(cm) <input id="height" type="number" value="175" style="width:70px">
  몸무게(kg) <input id="weight" type="number" value="70" style="width:70px">
  나이 <input id="age" type="number" value="22" style="width:60px">
  주의부위 
  <select id="pain"><option value="none">없음</option><option value="knee">무릎</option><option value="back">허리</option><option value="shoulder">어깨</option></select>
  목표 
  <select id="goal"><option value="fatloss">체지방 감량</option><option value="strength">근력</option><option value="mobility">가동성</option></select>
  <button id="save" disabled>프로필 저장</button>
</div>

<script>
(() => {
  const btn = document.getElementById('btn');
  const stateEl = document.getElementById('state');
  const img = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');

  const stepEl = document.getElementById('step');
  const phaseEl = document.getElementById('phase');
  const adviceEl = document.getElementById('advice');
  const cmppxEl = document.getElementById('cmppx');
  const saveBtn = document.getElementById('save');
  const heightEl = document.getElementById('height');
  const weightEl = document.getElementById('weight');
  const ageEl = document.getElementById('age');
  const painEl = document.getElementById('pain');
  const goalEl = document.getElementById('goal');

  const pairs = [
    ['left_shoulder','left_elbow'],['left_elbow','left_wrist'],
    ['right_shoulder','right_elbow'],['right_elbow','right_wrist'],
    ['left_shoulder','left_hip'],['right_shoulder','right_hip'],
    ['left_hip','left_knee'],['left_knee','left_ankle'],
    ['right_hip','right_knee'],['right_knee','right_ankle']
  ];

  function drawSkeleton(keypoints, size){
    if(size && (canvas.width!==size.w || canvas.height!==size.h)){
      canvas.width=size.w; canvas.height=size.h;
    }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!keypoints) return;
    const dict={}; keypoints.forEach(k=>{ if((k.score??0)>0.3) dict[k.name||k.part]=k; });
    ctx.lineWidth=3; ctx.strokeStyle='#39b3ff'; ctx.fillStyle='#ffd66e';
    pairs.forEach(([a,b])=>{
      const A=dict[a],B=dict[b]; if(A&&B){ ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke(); }
    });
    Object.values(dict).forEach(k=>{ if(k.score>0.45){ ctx.beginPath(); ctx.arc(k.x,k.y,4,0,Math.PI*2); ctx.fill(); }});
  }

  let wsImg=null, wsPose=null, lastURL=null;
  let step=1, cmppx=null, stepLocked=false;

  function updatePhase(){
    const label = ['준비','정자세(키 보정)','스쿼트','힙힌지','오버헤드','요약'][step]||'요약';
    stepEl.textContent = String(Math.min(step,4));
    phaseEl.textContent = label;
  }
  updatePhase();

  function start(){
    // 1) 영상
    wsImg = new WebSocket("ws://127.0.0.1:8000/ws");
    wsImg.binaryType='blob';
    wsImg.onopen = ()=>{ stateEl.textContent='video: connected'; };
    wsImg.onmessage = (ev)=>{
      if(lastURL) URL.revokeObjectURL(lastURL);
      const url = URL.createObjectURL(ev.data);
      img.src = url; lastURL=url;
    };
    wsImg.onclose = ()=>{ stateEl.textContent='video: closed'; };

    // 2) 포즈/메트릭
    const h = Number(heightEl.value)||undefined;
    const qs = h? `?height_cm=${encodeURIComponent(h)}` : '';
    wsPose = new WebSocket(`ws://127.0.0.1:8000/ws/pose${qs}`);
    wsPose.onmessage = (ev)=>{
      const j = JSON.parse(ev.data);
      drawSkeleton(j.keypoints, j.size);
      adviceEl.textContent = j.advice || '—';
      if(j.cm_per_px){ cmppx = j.cm_per_px; cmppxEl.textContent = j.cm_per_px.toFixed(3); }

      // 자동 진행 로직(전신 잘 잡히고 cm/px 확인되면 step 2로, 이후 metrics 변화에 맞춰 step↑)
      if(!stepLocked){
        if(step===1 && cmppx){ step=2; updatePhase(); }
        // 심플: 오버헤드 OK 나오면 마지막 단계로
        if(step>=2 && j.metrics && j.metrics.overhead_ok){ step=5; updatePhase(); saveBtn.disabled=false; stepLocked=true; }
      }

      // 저장 시 사용할 최신 프로필 캐시
      window.__lastPose = j;
    };
    btn.textContent='끄기';
  }

  function stop(){
    if(wsImg && wsImg.readyState===WebSocket.OPEN) wsImg.close();
    if(wsPose && wsPose.readyState===WebSocket.OPEN) wsPose.close();
    wsImg = wsPose = null;
    if(lastURL){ URL.revokeObjectURL(lastURL); lastURL=null; }
    img.src=''; ctx.clearRect(0,0,canvas.width,canvas.height);
    btn.textContent='웹캠 켜기'; stateEl.textContent='idle';
  }

  btn.onclick = ()=>{ if(btn.textContent==='웹캠 켜기') start(); else stop(); };

  saveBtn.onclick = async ()=>{
    const j = window.__lastPose;
    if(!j || !j.metrics){ alert('측정 데이터가 부족합니다.'); return; }
    const payload = {
      version:'v2',
      body:{
        height_cm: Number(heightEl.value)||null,
        weight_kg: Number(weightEl.value)||null,
        age: Number(ageEl.value)||null,
        pain: painEl.value, goal: goalEl.value
      },
      measures:{
        knee_min_angle_deg: j.metrics.knee_min_angle_deg ?? null,
        trunk_max_flexion_deg: j.metrics.trunk_max_flexion_deg ?? null,
        valgus_index_max: j.metrics.valgus_index_max ?? 0,
        overhead_ok: !!j.metrics.overhead_ok,
        lengths_cm: j.metrics.lengths_cm ?? null
      },
      thresholds: j.metrics.thresholds || null,
      cm_per_px: j.cm_per_px ?? null,
      notes: 'Profile from YOLOv8-Pose WS'
    };
    const res = await fetch('/api/profile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const r = await res.json();
    if(r.ok){ alert('저장 완료! id: '+r.id); } else { alert('저장 실패'); }
  };
})();
</script>
</body>
